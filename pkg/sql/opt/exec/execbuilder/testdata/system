# LogicTest: local

# ------------------------------------------------------------------------------
# Tests for system.statement_hints.
# ------------------------------------------------------------------------------

# Query by fingerprint.
query T
EXPLAIN (OPT, VERBOSE) SELECT * FROM system.statement_hints WHERE fingerprint = 'SELECT * FROM t WHERE x = _'
----
select
 ├── columns: row_id:1 fingerprint:3 hint:4 created_at:5 hint_type:6 hint_name:7 enabled:8 database:9
 ├── stats: [rows=10, distinct(3)=1, null(3)=0]
 ├── cost: 92.0700007
 ├── cost-flags: unbounded-cardinality
 ├── key: (1)
 ├── fd: ()-->(3), (1)-->(4-9)
 ├── distribution: test
 ├── prune: (1,4-9)
 ├── index-join statement_hints
 │    ├── columns: row_id:1 fingerprint:3 hint:4 created_at:5 hint_type:6 hint_name:7 enabled:8 database:9
 │    ├── stats: [rows=10]
 │    ├── cost: 91.9400007
 │    ├── cost-flags: unbounded-cardinality
 │    ├── key: (1)
 │    ├── fd: (1)-->(3-9)
 │    ├── distribution: test
 │    └── scan statement_hints@hash_idx
 │         ├── columns: row_id:1
 │         ├── constraint: /2/1: [/6457443302007961978 - /6457443302007961978]
 │         ├── stats: [rows=10, distinct(2)=1, null(2)=0]
 │         ├── cost: 28.6200001
 │         ├── cost-flags: unbounded-cardinality
 │         ├── key: (1)
 │         └── distribution: test
 └── filters
      └── fingerprint:3 = 'SELECT * FROM t WHERE x = _' [outer=(3), constraints=(/3: [/'SELECT * FROM t WHERE x = _' - /'SELECT * FROM t WHERE x = _']; tight), fd=()-->(3)]

# Query by hash.
query T
EXPLAIN (OPT, VERBOSE) SELECT * FROM system.statement_hints WHERE hash = 123
----
project
 ├── columns: row_id:1 fingerprint:3 hint:4 created_at:5 hint_type:6 hint_name:7 enabled:8 database:9
 ├── stats: [rows=10]
 ├── cost: 92.2600007
 ├── cost-flags: unbounded-cardinality
 ├── key: (1)
 ├── fd: (1)-->(3-9)
 ├── distribution: test
 ├── prune: (1,3-9)
 └── index-join statement_hints
      ├── columns: row_id:1 hash:2 fingerprint:3 hint:4 created_at:5 hint_type:6 hint_name:7 enabled:8 database:9
      ├── stats: [rows=10, distinct(2)=1, null(2)=0]
      ├── cost: 92.1400007
      ├── cost-flags: unbounded-cardinality
      ├── key: (1)
      ├── fd: ()-->(2), (1)-->(3-9)
      ├── distribution: test
      └── scan statement_hints@hash_idx
           ├── columns: row_id:1 hash:2
           ├── constraint: /2/1: [/123 - /123]
           ├── stats: [rows=10, distinct(2)=1, null(2)=0]
           ├── cost: 28.8200001
           ├── cost-flags: unbounded-cardinality
           ├── key: (1)
           ├── fd: ()-->(2)
           └── distribution: test

# Select hidden hash column.
query T
EXPLAIN (OPT, VERBOSE) SELECT hash FROM system.statement_hints
----
scan statement_hints@hash_idx
 ├── columns: hash:2
 ├── stats: [rows=1000]
 ├── cost: 1088.62
 ├── cost-flags: unbounded-cardinality
 ├── distribution: test
 └── prune: (2)

# Query hash column by range.
query T
EXPLAIN (OPT, VERBOSE) SELECT hash FROM system.statement_hints WHERE hash >= 100 AND hash < 200
----
scan statement_hints@hash_idx
 ├── columns: hash:2
 ├── constraint: /2/1: [/100 - /199]
 ├── stats: [rows=1000, distinct(2)=100, null(2)=0]
 ├── cost: 1078.02
 ├── cost-flags: unbounded-cardinality
 └── distribution: test

# Query by row ID.
query T
EXPLAIN (OPT, VERBOSE) SELECT * FROM system.statement_hints WHERE row_id = 1
----
scan statement_hints
 ├── columns: row_id:1 fingerprint:3 hint:4 created_at:5 hint_type:6 hint_name:7 enabled:8 database:9
 ├── constraint: /1: [/1 - /1]
 ├── cardinality: [0 - 1]
 ├── stats: [rows=1, distinct(1)=1, null(1)=0]
 ├── cost: 9.35
 ├── key: ()
 ├── fd: ()-->(1,3-9)
 ├── distribution: test
 └── prune: (3-9)

# Delete by fingerprint and row ID.
query T
EXPLAIN (OPT, VERBOSE) DELETE FROM system.statement_hints WHERE fingerprint = 'SELECT * FROM t WHERE x = _' AND row_id = 1
----
delete statement_hints
 ├── columns: <none>
 ├── fetch columns: row_id:14 hash:15
 ├── cardinality: [0 - 0]
 ├── volatile, mutations
 ├── stats: [rows=0]
 ├── cost: 9.29
 ├── distribution: test
 └── select
      ├── columns: row_id:14 hash:15 fingerprint:16
      ├── cardinality: [0 - 1]
      ├── stats: [rows=1, distinct(14)=1, null(14)=0, distinct(16)=1, null(16)=0]
      ├── cost: 9.28
      ├── key: ()
      ├── fd: ()-->(14-16)
      ├── distribution: test
      ├── prune: (15)
      ├── scan statement_hints
      │    ├── columns: row_id:14 hash:15 fingerprint:16
      │    ├── constraint: /14: [/1 - /1]
      │    ├── flags: avoid-full-scan
      │    ├── cardinality: [0 - 1]
      │    ├── stats: [rows=1, distinct(14)=1, null(14)=0]
      │    ├── cost: 9.25
      │    ├── key: ()
      │    ├── fd: ()-->(14-16)
      │    └── distribution: test
      └── filters
           └── fingerprint:16 = 'SELECT * FROM t WHERE x = _' [outer=(16), constraints=(/16: [/'SELECT * FROM t WHERE x = _' - /'SELECT * FROM t WHERE x = _']; tight), fd=()-->(16)]

# Query used by the cache to check for hint existence.
query T
EXPLAIN (OPT, VERBOSE) SELECT hash FROM system.statement_hints WHERE hash = 123456 LIMIT 1
----
scan statement_hints@hash_idx
 ├── columns: hash:2
 ├── constraint: /2/1: [/123456 - /123456]
 ├── limit: 1
 ├── stats: [rows=1]
 ├── cost: 9.07
 ├── key: ()
 ├── fd: ()-->(2)
 └── distribution: test

# Query used to enforce the global concurrency limit of auto full stats
# collections.
query T
EXPLAIN
SELECT array_cat_agg(job_ids)
FROM system.table_statistics_locks
WHERE table_id = 0
AND kind = 1
FOR UPDATE OF table_statistics_locks
----
distribution: local
·
• group (scalar)
│
└── • scan
      missing stats
      table: table_statistics_locks@primary
      spans: [/0/1 - /0/1]
      locking strength: for update
